
name: build-agentd

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Build agentd (ios/arm64)
        working-directory: agentd
        run: |
          go mod download
          SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          CC="$(xcrun --sdk iphoneos --find clang)"
          CXX="$(xcrun --sdk iphoneos --find clang++)"
          export SDKROOT CC CXX
          export CGO_ENABLED=1 GOOS=ios GOARCH=arm64
          export CGO_CFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0"
          export CGO_LDFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0"
          go build -trimpath -ldflags "-s -w -linkmode external" -o dist/agentd-ios-arm64 ./cmd/agentd
          codesign --sign - --force --timestamp=none dist/agentd-ios-arm64
          echo "=== verify Mach-O platform ==="
          file dist/agentd-ios-arm64
          otool -l dist/agentd-ios-arm64 | grep -n "LC_BUILD_VERSION" -A3 | head -n 30
          PLATFORM="$(otool -l dist/agentd-ios-arm64 | awk '$1=="cmd" && $2=="LC_BUILD_VERSION"{f=1} f && $1=="platform"{print $2; exit}')"
          if [ "$PLATFORM" != "2" ]; then
            echo "ERROR: expected iOS platform=2, got platform=$PLATFORM"
            exit 1
          fi

      - name: Install dpkg-deb (macOS)
        run: |
          brew list dpkg >/dev/null 2>&1 || brew install dpkg
          echo "$(brew --prefix)/bin" >> "$GITHUB_PATH"
          command -v dpkg-deb

      - name: Build agentd deb (ios/rootless)
        working-directory: agentd/ios-deb
        run: |
          set -euo pipefail
          REF_TYPE="${{ github.ref_type }}"
          REF_NAME="${{ github.ref_name }}"
          VERSION=""
          if [ "$REF_TYPE" = "tag" ]; then
            VERSION="${REF_NAME#v}"
          else
            VERSION="0.0.0+sha.${GITHUB_SHA::7}.run.${GITHUB_RUN_NUMBER}"
          fi
          case "$VERSION" in
            *-*) ;;
            *) VERSION="${VERSION}-1" ;;
          esac
          chmod 755 build.sh layout/DEBIAN/postinst layout/DEBIAN/prerm || true
          ./build.sh ../dist/agentd-ios-arm64 "$VERSION"
          ls -la packages/*.deb

      - name: Build broker (linux/amd64)
        working-directory: agentd
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "-s -w" -o dist/broker-linux-amd64 ./cmd/broker

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agentd-artifacts
          path: |
            agentd/dist/agentd-ios-arm64
            agentd/dist/broker-linux-amd64
            agentd/ios-deb/packages/*.deb
