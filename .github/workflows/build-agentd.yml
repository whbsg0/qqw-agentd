name: build-agentd

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Build agentd (ios/arm64)
        working-directory: agentd
        run: |
          go mod download
          REF_TYPE="${{ github.ref_type }}"
          REF_NAME="${{ github.ref_name }}"
          VERSION=""
          if [ "$REF_TYPE" = "tag" ]; then
            VERSION="1:${REF_NAME#v}"
          else
            VERSION="1:0.0.0+run.${GITHUB_RUN_NUMBER}+sha.${GITHUB_SHA::7}"
          fi
          case "$VERSION" in
            *-*) ;;
            *) VERSION="${VERSION}-1" ;;
          esac
          SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          CC="$(xcrun --sdk iphoneos --find clang)"
          CXX="$(xcrun --sdk iphoneos --find clang++)"
          export SDKROOT CC CXX
          export CGO_ENABLED=1 GOOS=ios GOARCH=arm64
          export CGO_CFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0"
          export CGO_LDFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0"
          go build -trimpath -ldflags "-s -w -linkmode external -X main.buildVersion=$VERSION -X main.buildCommit=${GITHUB_SHA::7}" -o dist/agentd-ios-arm64 ./cmd/agentd
          codesign --sign - --force --timestamp=none dist/agentd-ios-arm64
          echo "=== verify Mach-O platform ==="
          file dist/agentd-ios-arm64
          otool -l dist/agentd-ios-arm64 | grep -n "LC_BUILD_VERSION" -A3 | head -n 30
          PLATFORM="$(otool -l dist/agentd-ios-arm64 | awk '$1=="cmd" && $2=="LC_BUILD_VERSION"{f=1} f && $1=="platform"{print $2; exit}')"
          if [ "$PLATFORM" != "2" ]; then
            echo "ERROR: expected iOS platform=2, got platform=$PLATFORM"
            exit 1
          fi

      - name: Build qqw-script-runner (ios/arm64)
        working-directory: agentd
        run: |
          set -euo pipefail
          go mod download
          FRIDA_CORE_VERSION="16.7.19"
          DEVKIT_DIR="$(pwd)/dist/frida-core-devkit"
          mkdir -p "$DEVKIT_DIR"

          DEVKIT_TAR="/tmp/frida-core-devkit.tar.xz"
          rm -f "$DEVKIT_TAR"
          for SUFFIX in ios-arm64 ios-arm64e ios-arm64eoabi; do
            URL="https://github.com/frida/frida/releases/download/${FRIDA_CORE_VERSION}/frida-core-devkit-${FRIDA_CORE_VERSION}-${SUFFIX}.tar.xz"
            echo "download: $URL"
            if curl -fsSL -o "$DEVKIT_TAR" "$URL"; then
              break
            fi
          done
          if [ ! -f "$DEVKIT_TAR" ]; then
            echo "ERROR: devkit download failed" >&2
            exit 1
          fi

          rm -rf "$DEVKIT_DIR"/*
          tar -xJf "$DEVKIT_TAR" -C "$DEVKIT_DIR"
          INCLUDE_DIR="$(find "$DEVKIT_DIR" -maxdepth 3 -type d -name include -print -quit || true)"
          if [ -z "$INCLUDE_DIR" ] || [ ! -d "$INCLUDE_DIR" ]; then
            echo "ERROR: devkit include dir missing under: $DEVKIT_DIR" >&2
            ls -la "$DEVKIT_DIR" || true
            exit 1
          fi
          DEVKIT_ROOT="$(dirname "$INCLUDE_DIR")"
          LIBDIR="$DEVKIT_ROOT"
          if [ -d "$DEVKIT_ROOT/lib" ]; then LIBDIR="$DEVKIT_ROOT/lib"; fi
          INCLUDES="-I$DEVKIT_DIR/include"
          INCLUDES="-I$INCLUDE_DIR"
          for d in "$INCLUDE_DIR/glib-2.0" "$INCLUDE_DIR/gio-unix-2.0" "$INCLUDE_DIR/json-glib-1.0"; do
            if [ -d "$d" ]; then INCLUDES="$INCLUDES -I$d"; fi
          done
          for d in "$LIBDIR/glib-2.0/include" "$LIBDIR/gio-unix-2.0/include"; do
            if [ -d "$d" ]; then INCLUDES="$INCLUDES -I$d"; fi
          done
          LDFLAGS_EXTRA="-framework Foundation -framework CoreFoundation -framework Security"
          if [ -f "$LIBDIR/libfrida-core.a" ]; then
            LDFLAGS_EXTRA="$LDFLAGS_EXTRA $LIBDIR/libfrida-core.a"
            for f in "$LIBDIR"/*.a; do
              if [ "$(basename "$f")" != "libfrida-core.a" ]; then
                LDFLAGS_EXTRA="$LDFLAGS_EXTRA $f"
              fi
            done
          else
            LDFLAGS_EXTRA="$LDFLAGS_EXTRA -L$LIBDIR -lfrida-core"
          fi
          SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          CC="$(xcrun --sdk iphoneos --find clang)"
          CXX="$(xcrun --sdk iphoneos --find clang++)"
          export SDKROOT CC CXX
          export CGO_ENABLED=1 GOOS=ios GOARCH=arm64
          export CGO_CFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0 $INCLUDES"
          export CGO_LDFLAGS="-isysroot $SDKROOT -miphoneos-version-min=13.0 $LDFLAGS_EXTRA"
          go build -trimpath -ldflags "-s -w -linkmode external" -o dist/qqw-script-runner-ios-arm64 ./cmd/qqw-script-runner
          codesign --sign - --force --timestamp=none dist/qqw-script-runner-ios-arm64
          echo "=== verify Mach-O platform ==="
          file dist/qqw-script-runner-ios-arm64
          otool -l dist/qqw-script-runner-ios-arm64 | grep -n "LC_BUILD_VERSION" -A3 | head -n 30
          PLATFORM="$(otool -l dist/qqw-script-runner-ios-arm64 | awk '$1=="cmd" && $2=="LC_BUILD_VERSION"{f=1} f && $1=="platform"{print $2; exit}')"
          if [ "$PLATFORM" != "2" ]; then
            echo "ERROR: expected iOS platform=2, got platform=$PLATFORM"
            exit 1
          fi

      - name: Install dpkg-deb (macOS)
        run: |
          brew list dpkg >/dev/null 2>&1 || brew install dpkg
          echo "$(brew --prefix)/bin" >> "$GITHUB_PATH"
          command -v dpkg-deb

      - name: Build agentd deb (ios/rootless)
        working-directory: agentd/ios-deb
        run: |
          set -euo pipefail
          REF_TYPE="${{ github.ref_type }}"
          REF_NAME="${{ github.ref_name }}"
          VERSION=""
          if [ "$REF_TYPE" = "tag" ]; then
            VERSION="1:${REF_NAME#v}"
          else
            VERSION="1:0.0.0+run.${GITHUB_RUN_NUMBER}+sha.${GITHUB_SHA::7}"
          fi
          case "$VERSION" in
            *-*) ;;
            *) VERSION="${VERSION}-1" ;;
          esac
          chmod 755 build.sh layout/DEBIAN/postinst layout/DEBIAN/prerm || true
          ./build.sh ../dist/agentd-ios-arm64 "$VERSION" ../dist/qqw-script-runner-ios-arm64
          ls -la packages/*.deb

      - name: Build broker (linux/amd64)
        working-directory: agentd
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "-s -w" -o dist/broker-linux-amd64 ./cmd/broker

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agentd-artifacts
          path: |
            agentd/dist/agentd-ios-arm64
            agentd/dist/qqw-script-runner-ios-arm64
            agentd/dist/broker-linux-amd64
            agentd/ios-deb/packages/*.deb
